{# Macro to resolve i18n fields: if dict with lang keys, return lang value; else return as-is #}
{%- macro t(value) %}{% if value is mapping and lang in value %}{{ value[lang] }}{% else %}{{ value }}{% endif %}{% endmacro -%}
{%- macro stars(n) %}{% for _ in range(n) %}⭐{% endfor %}{% endmacro -%}
<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV - {{ cv.personal.name }}{% if lang == 'en' %} (English){% endif %}</title>
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" as="style">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link rel="stylesheet" href="static/styles.css">
</head>
<body class="py-10 print:py-0">

    <!-- Floating Buttons -->
    <div class="fixed bottom-8 right-8 no-print z-50 flex flex-col gap-3 items-end">
        <button onclick="toggleAIModal()" class="bg-gray-900 hover:bg-gray-800 text-white font-bold py-3 px-6 rounded-full shadow-lg flex items-center gap-2 transition-all transform hover:scale-105 border border-gray-700 group">
            <i class="fas fa-sparkles text-yellow-400 group-hover:animate-spin"></i>
            <span>AI Career Suite{% if lang == 'en' %} (EN){% endif %}</span>
        </button>
        <button id="btnDownload" onclick="downloadPDF()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-full shadow-lg flex items-center gap-2 transition-all transform hover:scale-105">
            <i class="fas fa-file-pdf"></i> {% if lang == 'es' %}Guardar PDF{% else %}Save PDF{% endif %}
        </button>
    </div>

    <!-- AI Modal -->
    <div id="aiModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 items-center justify-center z-50 no-print backdrop-blur-sm transition-all duration-300">
        <div class="bg-white w-full max-w-2xl rounded-xl shadow-2xl overflow-hidden m-4 flex flex-col max-h-[90vh]">
            <div class="bg-gray-50 border-b p-4 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <div class="bg-blue-600 text-white p-1.5 rounded-lg"><i class="fas fa-robot"></i></div>
                    <h3 class="font-bold text-gray-800">AI Career Assistant{% if lang == 'en' %} (English Mode){% endif %}</h3>
                </div>
                <button onclick="toggleAIModal()" class="hover:bg-gray-200 p-2 rounded-full transition-colors"><i class="fas fa-times text-gray-500"></i></button>
            </div>
            <div class="p-6 overflow-y-auto flex-grow bg-white" id="aiContentArea">
                <div id="aiMenu" class="text-center space-y-6">
                    <div id="apiKeyStatus" class="text-xs"></div>
                    <p class="text-gray-600">{% if lang == 'es' %}Selecciona una herramienta:{% else %}Prepare for the international market:{% endif %}</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button onclick="generateElevatorPitch()" class="border border-gray-200 p-5 rounded-xl hover:border-purple-500 hover:bg-purple-50 transition text-left group">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="bg-purple-100 p-2 rounded-lg group-hover:bg-purple-200"><i class="fas fa-bullhorn text-purple-600"></i></div>
                                <h4 class="font-bold text-gray-800">Elevator Pitch{% if lang == 'en' %} (EN){% endif %}</h4>
                            </div>
                            <p class="text-xs text-gray-500">{% if lang == 'es' %}Discurso de 30s.{% else %}30s professional intro in English.{% endif %}</p>
                        </button>
                        <button onclick="startMockInterview()" class="border border-gray-200 p-5 rounded-xl hover:border-green-500 hover:bg-green-50 transition text-left group">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="bg-green-100 p-2 rounded-lg group-hover:bg-green-200"><i class="fas fa-code-branch text-green-600"></i></div>
                                <h4 class="font-bold text-gray-800">{% if lang == 'es' %}Entrevista Técnica{% else %}Tech Interview (EN){% endif %}</h4>
                            </div>
                            <p class="text-xs text-gray-500">{% if lang == 'es' %}Preguntas Azure/RAG.{% else %}Practice English interview questions.{% endif %}</p>
                        </button>
                        <button onclick="showInputView('coverLetter')" class="border border-gray-200 p-5 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition text-left group">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="bg-blue-100 p-2 rounded-lg group-hover:bg-blue-200"><i class="fas fa-file-pen text-blue-600"></i></div>
                                <h4 class="font-bold text-gray-800">{% if lang == 'es' %}Carta Presentación{% else %}Cover Letter (EN){% endif %}</h4>
                            </div>
                            <p class="text-xs text-gray-500">{% if lang == 'es' %}Personalizada por empresa.{% else %}Generate a tailored cover letter.{% endif %}</p>
                        </button>
                        <button onclick="showInputView('gapAnalysis')" class="border border-gray-200 p-5 rounded-xl hover:border-orange-500 hover:bg-orange-50 transition text-left group">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="bg-orange-100 p-2 rounded-lg group-hover:bg-orange-200"><i class="fas fa-chart-pie text-orange-600"></i></div>
                                <h4 class="font-bold text-gray-800">Gap Analysis</h4>
                            </div>
                            <p class="text-xs text-gray-500">{% if lang == 'es' %}Comparativa de rol.{% else %}Compare your profile to a target role.{% endif %}</p>
                        </button>
                    </div>
                </div>
                <div id="aiInputView" class="hidden flex-col space-y-4">
                    <h4 id="inputTitle" class="font-bold text-lg text-gray-800 text-center mb-2"></h4>
                    <div id="inputForm" class="space-y-3"></div>
                    <div class="flex gap-3 pt-2">
                        <button onclick="resetAI()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 rounded-lg">{% if lang == 'es' %}Cancelar{% else %}Cancel{% endif %}</button>
                        <button id="inputActionBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-semibold">{% if lang == 'es' %}Generar{% else %}Generate{% endif %}</button>
                    </div>
                </div>
                <div id="aiKeySetup" class="hidden space-y-4">
                    <div class="text-center">
                        <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-4">
                            <i class="fas fa-key text-amber-500 text-2xl mb-2"></i>
                            <h4 class="font-bold text-gray-800 mb-1">{% if lang == 'es' %}Configurar API Key{% else %}Configure API Key{% endif %}</h4>
                            <p class="text-sm text-gray-600">{% if lang == 'es' %}Se requiere una API key de Gemini. Se guardará en tu navegador (localStorage).{% else %}A Gemini API key is required. It will be saved in your browser (localStorage).{% endif %}</p>
                        </div>
                        <input type="password" id="apiKeyInput" placeholder="AIza..." class="w-full border border-gray-300 p-3 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        <p class="text-xs text-gray-400 mt-2">{% if lang == 'es' %}Obtén tu key en: <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-500 hover:underline">aistudio.google.com</a>{% else %}Get your key at: <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-500 hover:underline">aistudio.google.com</a>{% endif %}</p>
                    </div>
                    <div class="flex gap-3 pt-2">
                        <button onclick="resetAI()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 rounded-lg">{% if lang == 'es' %}Cancelar{% else %}Cancel{% endif %}</button>
                        <button id="saveApiKeyBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-semibold">{% if lang == 'es' %}Guardar{% else %}Save{% endif %}</button>
                    </div>
                </div>
                <div id="aiLoading" class="hidden flex-col items-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-100 border-t-blue-600 mb-4"></div>
                    <p class="text-gray-600 font-medium animate-pulse">{% if lang == 'es' %}Consultando a Gemini...{% else %}Consulting Gemini...{% endif %}</p>
                </div>
                <div id="aiResult" class="hidden space-y-4">
                    <div class="prose prose-sm max-w-none text-gray-700 bg-gray-50 p-5 rounded-xl border border-gray-100 shadow-inner" id="aiResponseText"></div>
                    <div id="interviewInputArea" class="hidden mt-4 pt-4 border-t border-gray-200">
                        <label class="block text-sm font-medium text-gray-700 mb-2">{% if lang == 'es' %}Respuesta:{% else %}Your Answer:{% endif %}</label>
                        <textarea id="userAnswer" rows="4" class="w-full border border-gray-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
                        <button onclick="submitAnswer()" class="mt-3 w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-semibold">{% if lang == 'es' %}Enviar{% else %}Submit Answer{% endif %}</button>
                    </div>
                    <button onclick="resetAI()" class="text-blue-600 hover:text-blue-800 text-sm font-medium mt-2 flex items-center gap-2"><i class="fas fa-arrow-left"></i> {% if lang == 'es' %}Volver{% else %}Back to Menu{% endif %}</button>
                </div>
            </div>
        </div>
    </div>

    <!-- CV Content -->
    <article id="cvContent" class="page text-gray-800" role="main" aria-label="Curriculum Vitae {% if lang == 'es' %}de{% else %}of{% endif %} {{ cv.personal.name }}">

        <!-- Header -->
        <header class="border-b-2 border-gray-200 pb-6 mb-6">
            <h1 class="text-4xl font-bold text-gray-900 tracking-tight uppercase">{{ cv.personal.name }}</h1>
            <h2 class="text-xl text-blue-700 font-semibold mt-1">{{ cv.personal.title }}</h2>

            <div class="flex flex-wrap gap-y-2 gap-x-6 mt-4 text-sm text-gray-600">
                <div class="flex items-center gap-2"><i class="fas fa-map-marker-alt text-gray-400"></i>{% if lang == 'es' %}{{ cv.personal.location.es }}{% else %} {{ cv.personal.location.en }}{% endif %}</div>
                <div class="flex items-center gap-2"><i class="fas fa-phone text-gray-400"></i> {{ cv.personal.phone }}</div>
                <div class="flex items-center gap-2"><i class="fas fa-envelope text-gray-400"></i> {{ cv.personal.email }}</div>
                <div class="flex items-center gap-2">
                    <a href="{{ cv.personal.linkedin.url }}" target="_blank" class="flex items-center gap-1 text-blue-600 hover:underline">
                        <i class="fab fa-linkedin"></i> {{ cv.personal.linkedin.label }}
                    </a>
                    <span class="text-gray-300">|</span>
                    <a href="{{ cv.personal.github.url }}" target="_blank" class="flex items-center gap-1 text-gray-800 hover:text-black hover:underline">
                        <i class="fab fa-github"></i> {{ cv.personal.github.label }}
                    </a>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">

            <!-- Main Column -->
            <div class="md:col-span-2 space-y-6">
                <!-- Profile -->
                <section>
                    <h3 class="text-lg font-bold text-gray-900 border-b border-gray-300 pb-1 mb-3 uppercase tracking-wider">{% if lang == 'es' %}Perfil Profesional{% else %}Professional Profile{% endif %}</h3>
                    <p class="text-sm text-justify leading-relaxed text-gray-700">
                        {{ cv.profile[lang] }}
                    </p>
                </section>

                <!-- Experience -->
                <section>
                    <h3 class="text-lg font-bold text-gray-900 border-b border-gray-300 pb-1 mb-4 uppercase tracking-wider">{% if lang == 'es' %}Experiencia Laboral{% else %}Work Experience{% endif %}</h3>
                    {% for exp in cv.experience %}
                    {% if lang in exp.langs %}
                    <div class="item-no-break {% if exp.current %}mb-6 relative pl-4 border-l-2 border-blue-600{% else %}mb-5{% endif %}">
                        <div class="flex justify-between items-baseline">
                            <h4 class="font-bold text-gray-900 text-base">{{ t(exp.title) }}</h4>
                            {% if exp.current %}
                            <span class="text-xs font-bold text-blue-700 bg-blue-50 px-2 py-0.5 rounded">{{ t(exp.date) }}</span>
                            {% else %}
                            <span class="text-xs text-gray-500 italic">{{ t(exp.date) }}</span>
                            {% endif %}
                        </div>
                        <div class="text-sm font-semibold text-blue-700 mb-2">{{ exp.company }}</div>
                        <ul class="list-disc list-outside ml-4 text-sm text-gray-700 space-y-1.5 leading-snug">
                            {% for item in exp['items'][lang] %}
                            <li>{{ item }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                    {% endfor %}
                </section>

                <!-- Projects -->
                <section>
                    <h3 class="text-lg font-bold text-gray-900 border-b border-gray-300 pb-1 mb-4 uppercase tracking-wider">{% if lang == 'es' %}Proyectos Open Source{% else %}Open Source Projects{% endif %}</h3>
                    {% for proj in cv.projects %}
                    <div class="mb-4 item-no-break">
                        <div class="flex items-baseline gap-2 mb-1">
                            <h4 class="font-bold text-gray-900 text-sm">{{ proj.emoji }} {{ t(proj.title) }}</h4>
                            <a href="{{ proj.url }}" target="_blank" class="text-xs text-blue-600 hover:underline">{{ proj.url_label }}</a>
                        </div>
                        <p class="text-xs text-gray-700 leading-snug mb-1">{{ t(proj.description) }}</p>
                        <p class="text-xs text-gray-500"><strong>Stack:</strong> {{ proj.stack }}</p>
                    </div>
                    {% endfor %}
                </section>
            </div>

            <!-- Side Column -->
            <div class="md:col-span-1 space-y-6">

                <!-- Education -->
                <section>
                    <h3 class="text-lg font-bold text-gray-900 border-b border-gray-300 pb-1 mb-3 uppercase tracking-wider">{% if lang == 'es' %}Educación{% else %}Education{% endif %}</h3>
                    {% for deg in cv.education.degrees %}
                    <div class="mb-3 item-no-break">
                        <h4 class="text-sm font-bold text-gray-900 leading-tight">{{ t(deg.title) }}</h4>
                        <p class="text-sm text-blue-700">{{ deg.institution }}</p>
                        <p class="text-xs text-gray-500{% if deg.current %} font-semibold{% endif %}">{{ t(deg.date) }}</p>
                    </div>
                    {% endfor %}

                    <div class="space-y-2 pt-2 border-t border-gray-100">
                        {% for dip in cv.education.diplomas %}
                        <div class="item-no-break">
                            <p class="text-xs font-bold text-gray-800">{{ t(dip.title) }}</p>
                            <p class="text-xs text-gray-500">{{ t(dip.institution) }}, {{ dip.year }}</p>
                        </div>
                        {% endfor %}
                    </div>
                </section>

                <!-- Tech Stack -->
                <section>
                    <h3 class="text-lg font-bold text-gray-900 border-b border-gray-300 pb-1 mb-3 uppercase tracking-wider">{% if lang == 'es' %}Stack Tecnológico{% else %}Tech Stack{% endif %}</h3>
                    <div class="space-y-3 text-xs">
                        {% for cat in cv.tech_stack %}
                        <div class="item-no-break">
                            <span class="text-xs font-bold text-gray-500 uppercase block mb-1.5">{{ cat.category }}</span>
                            <div class="space-y-1">
                                {% for line in cat['items'] %}
                                <div>
                                    {% for skill in line %}
                                    {% if not loop.first %} | {% endif %}
                                    <strong>{{ skill.name }}</strong> {{ stars(skill.stars) }}{% if skill.detail %} <span class="text-gray-500">{{ skill.detail }}</span>{% endif %}
                                    {% endfor %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </section>

                <!-- Power Skills -->
                <section>
                    <h3 class="text-lg font-bold text-gray-900 border-b border-gray-300 pb-1 mb-3 uppercase tracking-wider">Power Skills</h3>
                    <div class="flex flex-wrap gap-1.5 text-xs">
                        {% for skill in cv.power_skills[lang] %}
                        <span class="bg-blue-50 text-blue-700 px-2 py-1 rounded font-medium">{{ skill }}</span>
                        {% endfor %}
                    </div>
                </section>

                <!-- Languages -->
                <section>
                    <h3 class="text-lg font-bold text-gray-900 border-b border-gray-300 pb-1 mb-3 uppercase tracking-wider">{% if lang == 'es' %}Idiomas{% else %}Languages{% endif %}</h3>
                    <div class="space-y-2 text-sm">
                        {% for lng in cv.languages %}
                        <div class="item-no-break flex items-center gap-2">
                            <span class="text-lg">{{ lng.flag }}</span>
                            <div>
                                <p class="font-bold text-gray-900">{{ t(lng.name) }}</p>
                                <p class="text-xs text-gray-600">{{ t(lng.level) }}</p>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </section>

                <!-- Certifications -->
                <section>
                    <h3 class="text-lg font-bold text-gray-900 border-b border-gray-300 pb-1 mb-3 uppercase tracking-wider">{% if lang == 'es' %}Certificaciones{% else %}Certifications{% endif %}</h3>
                    <ul class="text-sm text-gray-700 space-y-2">
                        {% for cert in cv.certifications %}
                        <li class="item-no-break">
                            <strong class="text-gray-900">{{ t(cert.title) }}</strong>{% if cert.detail %} {{ cert.detail }}{% endif %}<br>
                            <span class="text-xs text-gray-500">{{ t(cert.institution) }}{% if cert.date %}, {{ t(cert.date) }}{% endif %}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </section>

            </div>
        </div>
    </article>

    <!-- Language-specific config for AI Suite -->
    <script>
        const CV_CONFIG = {
            _buildTimeKey: Boolean("{{ api_key }}"),
            apiKey: "{{ api_key }}" || localStorage.getItem("gemini_api_key") || "",
            pdfFilename: "{% if lang == 'es' %}CV_Alejandro_Ortiz.pdf{% else %}CV_Alejandro_Ortiz_EN.pdf{% endif %}",
            i18n: {
                generating: "{% if lang == 'es' %}Generando...{% else %}Generating...{% endif %}",
                pdfError: "{% if lang == 'es' %}Hubo un error. Usa Ctrl + P como alternativa.{% else %}Error generating PDF. Please use Ctrl + P as a backup.{% endif %}",
                connectionError: "{% if lang == 'es' %}Error de conexión.{% else %}Connection Error: Unable to reach Gemini.{% endif %}",
                keyFromBuild: "{% if lang == 'es' %}API key configurada (build){% else %}API key configured (build){% endif %}",
                keyFromBrowser: "{% if lang == 'es' %}API key guardada en navegador{% else %}API key saved in browser{% endif %}",
                noKey: "{% if lang == 'es' %}API key no configurada{% else %}API key not configured{% endif %}",
                configureKey: "{% if lang == 'es' %}Configurar{% else %}Configure{% endif %}",
                clearKey: "{% if lang == 'es' %}Borrar{% else %}Clear{% endif %}",
                interviewQuestionLabel: "{% if lang == 'es' %}Pregunta{% else %}\ud83e\udd16 Interview Question{% endif %}",
                coverLetter: {
                    title: "{% if lang == 'es' %}Detalles del Empleo{% else %}Job Details{% endif %}",
                    companyPlaceholder: "{% if lang == 'es' %}Empresa{% else %}Company Name{% endif %}",
                    rolePlaceholder: "{% if lang == 'es' %}Cargo{% else %}Job Title{% endif %}"
                },
                gapAnalysis: {
                    title: "{% if lang == 'es' %}Rol Soñado{% else %}Dream Job{% endif %}",
                    placeholder: "{% if lang == 'es' %}Rol Objetivo{% else %}Target Role (e.g., AI Architect){% endif %}"
                }
            },
            prompts: {
                {% if lang == 'es' %}
                elevatorPitch: (cv) => `Crea Elevator Pitch (30s) para AI Engineer. Resalta Maestría y Azure. CV: ${cv}`,
                mockInterview: (cv) => `Haz UNA pregunta técnica difícil sobre Azure AI o MLOps basada en CV: ${cv}`,
                submitAnswer: (q, a) => `Evalúa respuesta (1-10). Pregunta: ${q}. Respuesta: ${a}`,
                coverLetter: (comp, role, cv) => `Carta Presentación para ${role} en ${comp}. CV: ${cv}`,
                gapAnalysis: (role, cv) => `Gap Analysis para rol ${role}. CV: ${cv}`
                {% else %}
                elevatorPitch: (cv) => `Act as a Career Coach. Create a 30-40s "Elevator Pitch" for this AI Engineer profile. Highlight: Master's in Software Eng, Azure AI Search, and RAG. Tone: Professional and confident. Language: English. CV: ${cv}`,
                mockInterview: (cv) => `Act as a Senior Technical Recruiter. Ask ONE challenging situational technical question about Azure Document Intelligence, MLOps, or RAG based on this CV. DO NOT give the answer yet. Language: English. CV: ${cv}`,
                submitAnswer: (q, a) => `Evaluate this interview answer (1-10) and give constructive technical feedback. Question: "${q}". Candidate Answer: "${a}". Language: English.`,
                coverLetter: (comp, role, cv) => `Write a persuasive Cover Letter for the role of "${role}" at "${comp}". Use my CV details to connect my skills (Azure, RAG, Databricks) to the role. Structure: Opening, Why Me, Closing. Language: English. CV: ${cv}`,
                gapAnalysis: (role, cv) => `Act as a Senior Career Mentor. Target Role: "${role}". Analyze my current CV against market standards. Output (Markdown): 1. Strengths, 2. Gaps, 3. Action Plan. Language: English. CV: ${cv}`
                {% endif %}
            }
        };
    </script>
    <script src="static/ai-suite.js"></script>
</body>
</html>
